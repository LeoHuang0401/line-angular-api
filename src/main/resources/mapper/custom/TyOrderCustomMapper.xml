<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tw.com.imsoft.dao.mapper.custom.TyOrderCustomMapper">
  <resultMap id="BaseResultMap" type="tw.com.imsoft.dao.model.TyOrder">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 06 15:47:11 CST 2023.
    -->
    <id column="ORDER_NO" jdbcType="NUMERIC" property="orderNo" />
    <result column="MEM_ID" jdbcType="VARCHAR" property="memId" />
    <result column="STORE_ID" jdbcType="NUMERIC" property="storeId" />
    <result column="DISCOUNT" jdbcType="NUMERIC" property="discount" />
    <result column="TOTAL_PRICE" jdbcType="NUMERIC" property="totalPrice" />
    <result column="ORDER_TIME" jdbcType="TIMESTAMP" property="orderTime" />
    <result column="GET_TIME" jdbcType="TIMESTAMP" property="getTime" />
    <result column="STATUS" jdbcType="VARCHAR" property="status" />
  </resultMap>
  <resultMap id="OrderHistoryMap" type="tw.com.imsoft.domain.vo.orderHistory.OrderHistoryData">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 06 15:47:11 CST 2023.
    -->
    <id column="ORDER_NO" jdbcType="NUMERIC" property="orderNo" />
    <result column="TOTAL_PRICE" jdbcType="NUMERIC" property="totalPrice" />
    <result column="ORDER_TIME" jdbcType="TIMESTAMP" property="orderTime" />
    <result column="GET_TIME" jdbcType="TIMESTAMP" property="getTime" />
    <result column="STORE_NAME" jdbcType="VARCHAR" property="storeName" />
    <result column="REMARK" jdbcType="VARCHAR" property="remark" />
  </resultMap>
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 15 15:35:45 CST 2023.
    -->
    ORDER_NO, MEM_ID, STORE_ID, DISCOUNT, TOTAL_PRICE, ORDER_TIME, GET_TIME, STATUS
  </sql>
  
  <select id="getCount" resultType="int">
  SELECT CASE WHEN MAX(ORDER_NO)  IS NULL
         THEN 0 
         ELSE MAX(ORDER_NO)  END ORDER_NO
  FROM TY_ORDER
  </select>
  
  <select id="selectTotalPrice" parameterType="java.math.BigDecimal" resultType="java.math.BigDecimal">
  	SELECT TOTAL_PRICE
  	FROM TY_ORDER
  	WHERE ORDER_NO = #{orderNo,jdbcType=NUMERIC}
  </select>
  
  <select id="getOrderHistoryData" parameterType="java.lang.String" resultMap="OrderHistoryMap">
  	SELECT a.ORDER_NO
		   ,a.TOTAL_PRICE 
		   ,TO_CHAR(a.ORDER_TIME ,'MM/DD,HH24:mi') AS ORDER_TIME 
		   ,a.GET_TIME 
		   ,b.STORE_NAME 
		   ,CASE WHEN length(c.remark) > 12 THEN substr(c.remark,0,12) || '更多...' ELSE c.remark END AS REMARK 
	FROM TY_ORDER a
	LEFT JOIN store b ON a.STORE_ID = b.STORE_ID 
	LEFT JOIN 
		(SELECT 
					ORDER_NO 
				  ,LISTAGG(REMARK ,',') AS REMARK 
		FROM  TY_ORDER_DETAIL   
		GROUP BY ORDER_NO  
		ORDER BY ORDER_NO ASC)c 
	ON a.ORDER_NO = c.ORDER_NO
	WHERE a.MEM_ID  = #{memId,jdbcType=VARCHAR}
  	AND a.STATUS = 'Y'
  	ORDER BY a.ORDER_TIME DESC
  </select>
  
</mapper>